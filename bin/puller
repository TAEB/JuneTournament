#!/usr/bin/env perl
use strict;
use warnings;
use IO::Socket::INET;

my $logfile = 'xlogfile';

while (1) {
    eval {
        open my $loghandle, '>>', $logfile
            or die "Unable to open $logfile for appending: $!";

        my ($lines) = `wc -l $logfile` =~ /(\d+)/;
        ++$lines;
        my $socket;

        until ($socket) {
            $socket = IO::Socket::INET->new(
                PeerAddr => 'localhost',
                PeerPort => 9010,
            );
            sleep 1 if !$socket;
        }

        $socket->print("$lines\n");

        while (<$socket>) {
            print { $loghandle } $_;
            $loghandle->flush;
        }
    };
    warn $@ if $@;
    sleep 1;
}

